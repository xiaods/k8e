on:
  release:
    types:
      - published
name: Build Arm64 Release
jobs:
  build:
    name: Build & Release
    runs-on: [self-hosted, linux, ARM64]
    strategy:
      matrix:
        include:
          - goarch: arm64
            goos: linux
    env:
      RELEASE_TAG: ${{ secrets.RELEASE_TAG }}
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          check-latest: true
          cache-dependency-path: go.sum
      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.13.0
      - name: generate resources
        run: |
          mkdir -p build/data build/static
          zig build download
          make generate
      - name: build k8e
        run: make k8e
      - name: package bin
        run: make package-cli
      - name: package airgap image
        run: make package-airgap
      - name: sha256sum artifacts
        run: cd dist/artifacts/ && sha256sum k8e-${{ matrix.goarch }} k8e-airgap-images-${{ matrix.goarch }}.tar.gz >> k8e-hashes-${{ matrix.goarch }}.txt
      - name: Uploading assets...
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/artifacts/k8e-${{ matrix.goarch }}
            dist/artifacts/k8e-airgap-images-${{ matrix.goarch }}.tar.gz
            dist/artifacts/k8e-images-${{ matrix.goarch }}.txt
            dist/artifacts/k8e-hashes-${{ matrix.goarch }}.txt
